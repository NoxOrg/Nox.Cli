steps:  
  - name: Ensure the Project helm-chart Repository exists
    id: ensure-nox-helm-repo
    uses: azdevops/ensure-repo-exists@v1
    with:
      connection: ${{ steps.connect-devops.outputs.connection }}
      project-id: ${{ steps.get-nox-project.outputs.project-id }}
      repository-name: ${{ project.versionControl.project }}.Helmchart
    display:
      success: Ensured that the project helm-chart repository exists
      error: There was a problem ensuring that the project helm-chart repository exists. ${{ steps.ensure-nox-helm-repo.error-message }}
    run-at-server: true
  
  - name: Find the helm-chart main branch
    id: find-helm-main
    uses: azdevops/find-branch@v1
    with:
      connection: ${{ steps.connect-devops.outputs.connection }}
      repository-id: ${{ steps.ensure-nox-helm-repo.outputs.repository-id }}
      branch-name: main
    display:
      success: Successfully got the main branch for the helm-chart repo
      error: There was a problem getting the main branch for the helm-chart repo ${{ steps.find-helm-main.error-message }}
    run-at-server: true
  
  #Helmchart Project
  - name: Get the Cli project
    id: get-microservices-project
    uses: azdevops/get-project@v1
    with:
      connection: ${{ steps.connect-devops.outputs.connection }}
      project-name: Heimdall.Microservices
    display:
      success: Got the Heimdall.Microservices project
      error: There was a problem getting the Heimdall.Microservices project (${{ steps.get-microservices-project.error-message }})
    run-at-server: true
  
  - name: Get the helm chart reference repo
    id: get-helm-ref-repo
    uses: azdevops/get-repo@v1
    with:
      connection: ${{ steps.connect-devops.outputs.connection }}
      project-id: ${{ steps.get-microservices-project.outputs.project-id }}
      repository-name: Template.Helmchart
    display:
      success: Successfully got the the helm chart reference repo
      error: There was a problem getting the helm chart reference repo (${{ steps.get-helm-ref-repo.error-message }})
    run-at-server: true
  
  - name: Download the helm chart repo
    id: download-helm-ref-repo
    uses: azdevops/download-repo-branch@v1
    with:
      connection: ${{ steps.connect-devops.outputs.connection }}
      repository-id: ${{ steps.get-helm-ref-repo.outputs.repository-id }}
      branch-name: main
    display:
      success: Successfully downloaded branch 'main' of the Heimdall helm chart to ${{ steps.download-helm-chart-repo.outputs.local-repository-path }}
      error: There was a problem downloading the repository (${{ steps.download-helm-ref-repo.error-message }})
    run-at-server: true
  
  - name: Push Helm-chart to project main branch
    id: push-helm-repo-to-main
    if: '"${{ steps.find-helm-main.outputs.is-found }}" == "False"'
    uses: azdevops/push-folder@v1
    with:
      connection: ${{ steps.connect-devops.outputs.connection }}
      repository-id: ${{ steps.ensure-nox-helm-repo.outputs.repository-id }}
      source-path: ${{ steps.download-helm-ref-repo.outputs.local-repository-path }}
    display:
      success: Push helm-chart to project ${{ project.name }} success
      error: Push helm-chart to project ${{ project.name }} failed. (${{ steps.push-helm-repo-to-main.error-message }})
    run-at-server: true
  
  - name: Create new helm-chart branch
    id: create-new-helm-branch
    uses: azdevops/create-branch@v1
    with:
      connection: ${{ steps.connect-devops.outputs.connection }}
      repository-id: ${{ steps.ensure-nox-helm-repo.outputs.repository-id }}
    display:
      success: Successfully created new helm-chart branch -> ${{ steps.create-new-helm-branch.outputs.branch-name }}
      error: Failed to create new helm-chart branch -> ${{ steps.create-new-helm-branch.outputs.branch-name }}
    run-at-server: true
  
  - name: Download the new helm-chart branch
    id: download-helm-branch
    uses: azdevops/download-repo-branch@v1
    with:
      connection: ${{ steps.connect-devops.outputs.connection }}
      repository-id: ${{ steps.ensure-nox-helm-repo.outputs.repository-id }}
      branch-name: ${{ steps.create-new-helm-branch.outputs.branch-name }}
    display:
      success: Successfully downloaded branch '${{ steps.create-new-helm-branch.outputs.branch-name }}' of the repo to ${{ steps.download-helm-branch.outputs.local-repository-path }}
      error: There was a problem downloading the project helm-chart branch (${{ steps.download-helm-branch.error-message }})
    run-at-server: true
  
  # Copy the reference repo branch over the project branch
  - name: Copy reference repo to project repo
    id: copy-helm-to-project
    uses: file/copy-folder@v1
    with:
      source-path: ${{ steps.download-helm-ref-repo.outputs.local-repository-path }}
      target-path: ${{ steps.download-helm-branch.outputs.local-repository-path }}
    display:
      success: Copied reference repo to project repo
      error: Unable to copy reference repo to project repo (${{ steps.copy-helm-to-project.error-message }})
    run-at-server: true
  
  # Replace values.yaml
  - name: Values.yaml Replace
    id: replace-values-yaml
    uses: file/replace-strings@v1
    with:
      path: ${{ steps.download-helm-branch.outputs.local-repository-path }}/values.yaml
      replacements:
        "servicePlaceholderName": ${{ vars.project-dash-name }}
        "serviceVaultName": we-test-mp-kv-${{ vars.project-short-name }}
    display:
      success: Strings Replace in values.yaml success
      error: Strings Replace in values.yaml failed. (${{ steps.replace-values-yaml.error-message }})
    run-at-server: true
  
  # Replace chart.yaml
  - name: Chart.yaml Replace
    id: replace-chart-yaml
    uses: file/replace-strings@v1
    with:
      path: ${{ steps.download-helm-branch.outputs.local-repository-path }}/Chart.yaml
      replacements:
        "servicePlaceholderName": ${{ vars.project-dash-name }}
    display:
      success: Strings Replace in Chart.yaml success
      error: Strings Replace in Chart.yaml failed. (${{ steps.replace-chart-yaml.error-message }})
    run-at-server: true
  
  
  # Replace values-local.yaml
  - name: Values-local.yaml Replace
    id: replace-values-local-yaml
    uses: file/replace-strings@v1
    with:
      path: ${{ steps.download-helm-branch.outputs.local-repository-path }}/values-local.yaml
      replacements:
        "servicePlaceholderName": ${{ vars.project-dash-name }}
    display:
      success: Strings Replace values-local.yaml success
      error: Strings Replace values-local.yaml failed. (${{ steps.replace-values-local-yaml.error-message }})
    run-at-server: true
  
  # Replace values-production.yaml
  - name: Values-production.yaml Replace
    id: replace-values-production-yaml
    uses: file/replace-strings@v1
    with:
      path: ${{ steps.download-helm-branch.outputs.local-repository-path }}/values-production.yaml
      replacements:
        "servicePlaceholderName": ${{ vars.project-dash-name }}
        "serviceVaultName": we-prod-mp-kv-${{ vars.project-short-name }}
    display:
      success: Strings Replace values-production.yaml success
      error: Strings Replace values-production.yaml failed. (${{ steps.replace-values-production-yaml.error-message }})
    run-at-server: true
  
  # Replace values-test.yaml
  - name: Values-test.yaml Replace
    id: replace-values-test-yaml
    uses: file/replace-strings@v1
    with:
      path: ${{ steps.download-helm-branch.outputs.local-repository-path }}/values-test.yaml
      replacements:
        "servicePlaceholderName": ${{ vars.project-dash-name }}
        "serviceVaultName": we-test-mp-kv-${{ vars.project-short-name }}
    display:
      success: Strings Replace values-test.yaml success
      error: Strings Replace values-test.yaml failed. (${{ steps.replace-values-test-yaml.error-message }})
    run-at-server: true
  
  # Replace values-uat.yaml
  - name: Values-uat.yaml Replace
    id: replace-values-uat-yaml
    uses: file/replace-strings@v1
    with:
      path: ${{ steps.download-helm-branch.outputs.local-repository-path }}/values-uat.yaml
      replacements:
        "servicePlaceholderName": ${{ vars.project-dash-name }}
        "serviceVaultName": we-uat-mp-kv-${{ vars.project-short-name }}
    display:
      success: Strings Replace values-uat.yaml success
      error: Strings Replace values-uat.yaml failed. (${{ steps.replace-values-uat-yaml.error-message }})
    run-at-server: true
  
  - name: Push updated helm branch to project helm-chart repo
    id: merge-helm-repo
    uses: azdevops/merge-folder@v1
    with:
      connection: ${{ steps.connect-devops.outputs.connection }}
      repository-id: ${{ steps.ensure-nox-helm-repo.outputs.repository-id }}
      branch-name: ${{ steps.create-new-helm-branch.outputs.branch-name }}
      source-path: ${{ steps.download-helm-branch.outputs.local-repository-path }}
    display:
      success: Push updated helm-chart to project ${{ project.name }} success
      error: Push updated helm-chart to project ${{ project.name }} failed. (${{ steps.merge-helm-repo.error-message }})
    run-at-server: true